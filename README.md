# Coversheets

This is an ingredient intended for use with EPrints 3.4+. It is designed to add branded coversheets to PDF documents uploaded to an archive.  It allows coversheet templates to be uploaded and then allows you to choose to which eprint records these coversheets should be applied.

This ingredient is based on the [original Coversheets Bazaar plugin](https://bazaar.eprints.org/350/).  There are many improvements to this Bazaar plugin but the main difference is that it no longer uses EPrints' indexer but is instead can be run periodically from a cron job. This allows for better management of when coversheeting tasks run and also helps keep the indexer log clean.  A lot of the noise can be generated from coversheeting, particularly when parsing PDF documents.

This ingredients also requires the [openoffice ingredient](https://github.com/eprints/openoffice) to be installed along with a copy of OpenOffice or LibreOffice.


## Installation

1. Make sure the [openoffice ingredient](https://github.com/eprints/openoffice) is already installed, following the installation instructions for that ingredient.

2. Checkout this ingredient to EPrints' `ingredients/` directory.

3. Download the latest 3.x version of [Apache PDFBox](https://pdfbox.apache.org/download.html) as a standalone JAR file to the `bin/` directory of this ingredient.

4. From the `bin/` directory of this ingredient, create a symlink between this downloaded JAR file and its generic name used by the `stitchPDFs` script in this ingredients. E.g. `ln -s pdfbox-app-3.0.1.jar pdfbox-app.jar`

5. Add this ingredient to the inc file of the flavour used by your EPrints archive.  E.g. `EPRINTS\_PATH/flavours/pub\_lib/inc`

6. Run `epadmin update <ARCHIVE\_ID\> to update the EPrints database with the extra tables and columns needed for coversheets.

7. Run `epadmin test` to confirm there are no problems with EPrints' overall configuration.

8. Reload the webserver. E.g. `apachectl graceful`


## Usage

This section describes how to use the script in the `bin/` directory of the coverhseets ingredient. 

### Update Coversheets

This is the script below will check a specified number (i.e. `LIMIT`) of eprint records in your archive (i.e. `ARCHIVE\_ID` that have their `coversheets\_dirty` field is set to `TRUE` because relevant metadata has been changed in those eprint records that requires the associated PDF documents to have their coversheets updated because their information is no longer up to date.
```
bin/check_coversheets ARCHIVE_ID LIMIT
```

#### As a Cron Job 
Typically you would want to run this regularly as the `eprints` user as a cron job.  The following is a typical cron job you would want to add to the `eprints` user's crontab. (It is assumed EPrints is instal under the path `/opt/eprints3`):

```
*/15 * * * * /opt/eprints3/ingredients/coversheets/bin/check_coversheets_cron my\_archive 50 3600 2>&1 | grep -v -f /opt/eprints3/ingredients/coversheets/bin/ignore_warnings.txt
```
This uses an envelope script for `check\_coversheets` called `check\_coversheets\_cron` to make sure that multiple instances are not being run by cron at the same time. The `3600` specifies how many seconds to wait until it assumes that a previous run of `check\_coversheets\_cron` has died without completing.  If this is not specified it will assume 7200 seconds (2 hours). The above cron job will try to coversheets the PDF documents for up to 50 eprints every 15 minutes.  This is a conservative estimate of how long it will take to complete.  Having the protection of `check\_coversheets\_cron` means 15 could probably be reduced to 5 or fewer minutes.  The `grep` command after the script is intended to remove arbitrary noise generated by Apache PDFBox, as PDFs often have syntax issues which produce warning messages but these can typically be ignored rather than generate emails to the eprints' user's inbox.

#### Temporarily Disable Cron Job
If you need to make some changes to EPrints and don't want cron job to run for a while, rather than disabling the cron job (and potentially forgetting to re-enabled ot you can use the following command to disable the cron job for a set amount of time:
```
bin/disable_coversheets ARCHIVE_ID SECONDS
```
E.g. 
```
bin/disable_coversheets my_archive 3600
```

#### For Specific EPrint records
If there is a specific eprint record for which you want to update its PDF documents.  Then you can use a slightly modified version of the command:

```
bin/check_coversheets ARCHIVE_ID LIMIT --eprintid=EPRINT_ID
```
Let us say you want to update coversheets for eprint with ID 1234, the command might be:

```
bin/check_coversheets my_archive 1 --eprintid=1234
```


### Add Coversheets to Specific Documents

Generally, you should use the `check\_coversheets` script to just update all PDF documents for a specific eprint but if you have some reason you only want to update a particular PDF document you can use the following command:
```
bin/add_coversheet ARCHIVE_ID DOCUMENT_ID 
```
This will use the specific coversheet template determined by its criteria being applicable to the document's associated eprint record.  


### Remove Coversheets 

You might decides that you no longer want to use coversheets and want to remove all coversheeted PDFs to save disk space.  You can use this to remove all of these files
```
bin/delete_coversheets ARCHIVE_ID
```
Alternatively, if some EPrints no longer need coversheets due to a change in the criteria for a coversheet template and these do not get tidied up automatically in good time then coversheets can be removed from one of more individual eprint record documents.  E.g. 
```
bin/delete_coversheets my_archive 1,2,3,4
```


### Update Coversheet-related Metadata
```
If you have only just started using coversheets then updating coversheet-related metadata should not be necessary but if you were using an old version of coversheets, such as the on available in the [EPrints Bazaar](https://bazaar.eprints.org/350/), then you will want to run the following command to make sure all the metadata is in the correct format:
```
bin/update_coversheet_data ARCHIVE_ID
```


## Further Information

See https://wiki.eprints.org/w/Coversheets_Ingredient
